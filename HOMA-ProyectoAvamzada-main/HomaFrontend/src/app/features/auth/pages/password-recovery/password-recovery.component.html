<app-auth-template
  title="Recuperar contraseña"
  subtitle="Solicita un código y restablece tu acceso de forma segura."
>
  <div class="recovery-flow">
    <section class="recovery-card">
      <header>
        <p class="step">Paso 1</p>
        <h2>Solicita tu código</h2>
        <p>Ingresa el correo con el que te registraste. Te enviaremos un código válido por 15 minutos.</p>
      </header>

      <form [formGroup]="requestForm" (ngSubmit)="onSendRecoveryCode()" class="recovery-form">
        <app-form-field
          label="Correo registrado"
          placeholder="usuario@correo.com"
          type="email"
          [control]="emailControl"
        ></app-form-field>

        <button type="submit" class="btn btn-primary" [disabled]="isRequestingCode">
          <span *ngIf="!isRequestingCode">Enviar código</span>
          <span *ngIf="isRequestingCode">Enviando...</span>
        </button>
      </form>

      <div *ngIf="codeRequested" class="recovery-hint">
        <p>
          Código enviado a <strong>{{ lastEmailUsed }}</strong>.
          <span *ngIf="codigoExpiraEn">
            Vence a las {{ codigoExpiraEn | date: "shortTime" }} (15 minutos de vigencia).
          </span>
        </p>
        <button type="button" class="btn-link" (click)="resendCode()">Reenviar código</button>
      </div>
    </section>

    <section class="recovery-card" [class.recovery-card--disabled]="!codeRequested">
      <header>
        <p class="step">Paso 2</p>
        <h2>Restablece tu contraseña</h2>
        <p>Escribe el código que recibiste y la nueva contraseña que deseas utilizar.</p>
      </header>

      <form [formGroup]="resetForm" (ngSubmit)="onResetPassword()" class="recovery-form">
        <app-form-field
          label="Código de verificación"
          placeholder="Ingresa el código"
          type="text"
          [control]="getResetControl('codigo')"
        ></app-form-field>

        <app-form-field
          label="Nueva contraseña"
          placeholder="********"
          type="password"
          [control]="getResetControl('nuevaContrasena')"
        ></app-form-field>

        <app-form-field
          label="Confirmar contraseña"
          placeholder="********"
          type="password"
          [control]="getResetControl('confirmarContrasena')"
        ></app-form-field>

        <button type="submit" class="btn btn-primary" [disabled]="!codeRequested || isResettingPassword">
          <span *ngIf="!isResettingPassword">Restablecer contraseña</span>
          <span *ngIf="isResettingPassword">Aplicando cambios...</span>
        </button>
      </form>
    </section>

    <p *ngIf="errorMessage" class="message message--error">{{ errorMessage }}</p>
    <p *ngIf="successMessage" class="message message--success">{{ successMessage }}</p>

    <button type="button" class="btn-link mt-4" routerLink="/auth/login">
      Volver al inicio de sesión
    </button>
  </div>
</app-auth-template>
